<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ {{ 'ìˆ˜ì •' if mode == 'edit' else 'ë§Œë“¤ê¸°' }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* ===== GLOBAL ===== */
    * { box-sizing: border-box; }
    body.app-body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #121212; /* ë‹¤í¬ ë°°ê²½ */
      color: #e0e0e0;
      display: flex;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 220px;
      background-color: #1a1a1a;
      border-right: 1px solid #2a2a2a;
      height: 100vh;
      padding: 20px 16px;
      position: fixed;
      left: 0;
      top: 0;
    }
    .sidebar__username {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 24px;
    }
    .sidebar__menu {
      list-style: none;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .sidebar__menu a {
      text-decoration: none;
      color: #d0d0d0;
      padding: 8px;
      border-radius: 4px;
      display: block;
    }
    .sidebar__menu a:hover {
      background-color: #2b2b2b;
      color: #fff;
    }

    /* ===== PAGE CONTENT ===== */
    .page {
      max-width: 900px; /* ì½˜í…ì¸  ìµœëŒ€ ë„ˆë¹„ */
      margin-left: calc(220px + (100vw - 220px - 900px)/2); /* ì‚¬ì´ë“œë°” ì œì™¸ í›„ ì¤‘ì•™ */
      margin-right: auto;
      padding: 24px 16px 40px;
      flex: 1 1 auto;
    }

    /* ìƒë‹¨ í—¤ë” + ìƒë‹¨ ì €ì¥ ë²„íŠ¼ */
    .page__header {
      margin-bottom: 16px;
      position: sticky; /* í•„ìš” ì—†ìœ¼ë©´ ì´ ë‘ ì¤„ ì‚­ì œ */
      top: 0;
      z-index: 20;
      background: #121212;
      padding-top: 6px;
      padding-bottom: 12px;
      border-bottom: 1px solid #222;
    }
    .page__title {
      margin: 0 0 8px;
      font-size: 24px;
      color: #ffffff;
    }
    .page__actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .page__back { font-size: 14px; margin-bottom: 24px; }
    .page__back a { text-decoration: none; color: #8ab4f8; }
    .page__back a:hover { text-decoration: underline; }

    /* SECTION */
    .section { margin-bottom: 32px; }
    .section__title { margin: 0 0 12px; font-size: 18px; color: #ffffff; }

    /* SEARCH */
    .search { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .search__input {
      flex: 1; min-width: 220px; padding: 8px 10px; border-radius: 4px;
      border: 1px solid #333; background-color: #1e1e1e; color: #e0e0e0;
    }
    .search__button {
      padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer;
      background-color: #4dabf7; color: #000; font-size: 14px; font-weight: 600; transition: .15s;
    }
    .search__button:hover { background-color: #1d7bd7; }

    /* FORM */
    .form { display: flex; flex-direction: column; gap: 16px; }
    .form__group { display: flex; flex-direction: column; gap: 6px; max-width: 520px; }
    .form__label { font-size: 14px; font-weight: 600; color: #ffffff; }
    .form__input, .form__textarea {
      padding: 8px 10px; border-radius: 4px; border: 1px solid #333;
      background-color: #1e1e1e; color: #e0e0e0; font-size: 14px;
    }
    .form__textarea { resize: vertical; min-height: 80px; }
    .form__submit {
      align-self: flex-start;
      padding: 10px 18px; border-radius: 4px; border: none; cursor: pointer;
      background-color: #28a745; color: #000; font-size: 15px; font-weight: 600; transition: .15s;
    }
    .form__submit[disabled] { opacity: .5; cursor: not-allowed; }
    .form__submit:hover:not([disabled]) { background-color: #1c7f33; }

    /* ROW: í¼ ì™¼ìª½(ì…ë ¥) + ì˜¤ë¥¸ìª½(ë¯¸ë¦¬ë³´ê¸°) ë°°ì¹˜ */
    .cover-row { display: flex; gap: 18px; align-items: start; flex-wrap: wrap; }
    .cover-row__left { flex: 1 1 420px; min-width: 260px; }
    .cover-row__right { width: 220px; min-width: 140px; display: flex; align-items: center; justify-content: center; transform: translateY(7px); }

    /* COVER PREVIEW (1:1) */
    .cover-preview {
      width: 220px; aspect-ratio: 1/1; border-radius: 8px;
      background: linear-gradient(180deg,#141414,#1c1c1c);
      border: 1px solid #2a2a2a; display: grid; place-items: center;
      overflow: hidden; position: relative;
    }
    .cover-preview img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .cover-placeholder { color: #9e9e9e; font-size: 13px; text-align: center; padding: 8px; }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    .preview-overlay {
      position: absolute; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,0.35); color: #fff; font-size: 13px; z-index: 5;
    }
    .preview-overlay.show { display: flex; }
    .spinner {
      width: 28px; height: 28px; border: 3px solid rgba(255,255,255,0.12);
      border-top-color: rgba(255,255,255,0.9); border-radius: 50%; animation: spin .8s linear infinite; margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .preview-error {
      position: absolute; bottom: 6px; left: 6px; right: 6px; padding: 6px 8px;
      background: rgba(255,60,60,0.12); color: #ff8b8b; font-size: 12px;
      border-radius: 6px; text-align: center; display: none; z-index: 6;
    }
    .preview-error.show { display: block; }

    /* TABLE */
    .table-wrapper { background-color: #1e1e1e; border-radius: 6px; overflow: hidden; border: 1px solid #2a2a2a; }
    .table { width: 100%; border-collapse: collapse; font-size: 14px; color: #dcdcdc; }
    .table thead { background-color: #2a2a2a; color: #ffffff; }
    .table th, .table td { padding: 8px 10px; border-bottom: 1px solid #2f2f2f; text-align: left; }
    .table th:first-child, .table td:first-child, .table th:nth-child(2), .table td:nth-child(2) { text-align: center; width: 60px; }
    .table tbody tr:last-child td { border-bottom: none; }
    .cover-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }

    /* EMPTY STATE */
    .empty-state {
      font-size: 14px; background-color: #1e1e1e; padding: 16px 14px;
      border-radius: 6px; border: 1px solid #2a2a2a; color: #bdbdbd;
    }
    .empty-state a { color: #8ab4f8; text-decoration: none; }
    .empty-state a:hover { text-decoration: underline; }

    /* ERROR */
    .error-msg { color: #ff6b6b; font-size: 13px; margin-bottom: 8px; }

    /* ë°˜ì‘í˜• */
    @media (max-width: 720px) {
      .cover-row { gap: 12px; }
      .cover-row__right { width: 160px; }
      .cover-preview { width: 160px; }
    }
  </style>
</head>

<body class="app-body">
  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar">
    {% if session.get('user_id') %}
      <div class="sidebar__username">{{ session['username'] }} ë‹˜</div>
    {% else %}
      <div class="sidebar__username">Guest</div>
    {% endif %}

    <ul class="sidebar__menu">
      {% if session.get('user_id') %}
        <li><a href="{{ url_for('logout') }}">ë¡œê·¸ì•„ì›ƒ</a></li>
      {% else %}
        <li><a href="{{ url_for('login') }}">ë¡œê·¸ì¸</a></li>
      {% endif %}

      <li><a href="{{ url_for('index') }}">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</a></li>

      {% if session.get('user_id') %}
        <li><a href="{{ url_for('create_playlist') }}">+ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¶”ê°€</a></li>
      {% endif %}

      {% if session.get('is_admin') %}
        <li><a href="{{ url_for('manage_songs') }}">ğŸ› ë…¸ë˜ ê´€ë¦¬</a></li>
      {% endif %}
    </ul>
  </aside>

  <!-- ===== PAGE CONTENT ===== -->
  <div class="page">
    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="page__header">
      <h1 class="page__title">
        {{ 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìˆ˜ì •' if mode == 'edit' else 'ìƒˆ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°' }}
      </h1>

      <!-- ìƒë‹¨ ì €ì¥ ë²„íŠ¼ (í¼ ì™¸ë¶€) -->
      <div class="page__actions">
        <button
          type="submit"
          form="playlist-form"
          name="action"
          value="save"
          class="form__submit form__submit--top"
          id="save-button">
          {{ 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìˆ˜ì • ì €ì¥' if mode == 'edit' else 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì €ì¥' }}
        </button>
      </div>
    </header>

    <!-- í¼ ë° ë‚˜ë¨¸ì§€ ì½˜í…ì¸  -->
    <form id="playlist-form" method="POST"
      action="{% if mode == 'edit' %}{{ url_for('edit_playlist', playlist_id=playlist_id) }}{% else %}{{ url_for('create_playlist') }}{% endif %}"
      class="form">
      
      {% if error %}
      <div class="error-msg">{{ error }}</div>
      {% endif %}

      <!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì •ë³´ + ì»¤ë²„ ë¯¸ë¦¬ë³´ê¸° -->
      <section class="section">
        <h2 class="section__title">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì •ë³´</h2>
        <div class="cover-row">
          <div class="cover-row__left">
            <div class="form__group">
              <label class="form__label" for="playlist-title">ì œëª©</label>
              <input id="playlist-title" type="text" name="title" class="form__input"
                value="{{ title_value or '' }}" required>
            </div>
            <div class="form__group">
              <label class="form__label" for="playlist-description">ì„¤ëª…</label>
              <textarea id="playlist-description" name="description" class="form__textarea"
                rows="3">{{ description_value or '' }}</textarea>
            </div>
            <div class="form__group">
              <label class="form__label" for="playlist-cover-url">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì»¤ë²„ URL</label>
              <input id="playlist-cover-url" type="text" name="cover_url" class="form__input"
                placeholder="https://..." value="{{ cover_url_value or '' }}">
              <small style="font-size:12px; color:#666;">
                ë¹„ì›Œë‘ë©´ ì„ íƒëœ ê³¡ë“¤ ì¤‘ í•˜ë‚˜ì˜ ì»¤ë²„ ì´ë¯¸ì§€ê°€ ìë™ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
              </small>
            </div>
          </div>
          <div class="cover-row__right" aria-hidden="false">
            <div class="cover-preview" id="coverPreviewBox" aria-label="ì»¤ë²„ ë¯¸ë¦¬ë³´ê¸°">
              <div class="preview-overlay" id="previewOverlay">
                <div class="spinner" aria-hidden="true"></div>
                <div class="preview-overlay-text">ì´ë¯¸ì§€ ë¡œë”©...</div>
              </div>
              <img id="coverPreviewImg" src="" alt="í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì»¤ë²„ ë¯¸ë¦¬ë³´ê¸°" style="display:none;">
              <div class="cover-placeholder" id="coverPlaceholder">
                No cover<br><small style="color:#888;">ì»¤ë²„ URLì„ ì…ë ¥í•´ë³´ì„¸ìš”</small>
              </div>
              <div class="preview-error" id="coverPreviewError">ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ì„ íƒëœ ë…¸ë˜ (ìœ„ìª½ í…Œì´ë¸”) -->
      <section class="section">
        <h2 class="section__title">ì„ íƒëœ ë…¸ë˜</h2>

        <div class="table-wrapper" id="selected-wrapper" style="display:none;">
          <table class="table">
            <thead>
              <tr>
                <th>ì„ íƒ</th>
                <th>ì»¤ë²„</th>
                <th>ì œëª©</th>
                <th>ì•„í‹°ìŠ¤íŠ¸</th>
                <th>ì•¨ë²”</th>
              </tr>
            </thead>
            <tbody id="selected-tbody">
              {% if selected_songs and selected_songs|length > 0 %}
              {% for s in selected_songs %}
              <tr class="selected-row" data-song-id="{{ s['song_id'] }}">
                <td>
                  <input type="checkbox" class="song-checkbox song-checkbox-top" name="song_ids"
                    value="{{ s['song_id'] }}" data-song-id="{{ s['song_id'] }}" checked>
                </td>
                <td>
                  {% if s['cover_url'] %}
                  <img src="{{ s['cover_url'] }}" alt="cover" class="cover-thumb">
                  {% endif %}
                </td>
                <td>{{ s['title'] }}</td>
                <td>{{ s['artist'] or '-' }}</td>
                <td>{{ s['album'] or '-' }}</td>
              </tr>
              {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </div>

        <div class="empty-state" id="selected-empty">
          ì•„ì§ ì„ íƒëœ ë…¸ë˜ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ëª©ë¡ì—ì„œ ë…¸ë˜ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”.
        </div>
      </section>

      <!-- ë…¸ë˜ ê²€ìƒ‰ -->
      <section class="section">
        <h2 class="section__title">ë…¸ë˜ ê²€ìƒ‰</h2>
        <div class="search">
          <input type="text" name="q" class="search__input" placeholder="ì œëª©/ì•„í‹°ìŠ¤íŠ¸/ì•¨ë²” ê²€ìƒ‰"
            value="{{ search_query or '' }}">
          <button type="submit" name="action" value="search" class="search__button">ê²€ìƒ‰</button>
        </div>
      </section>

      <!-- ë…¸ë˜ ì„ íƒ (ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸”) -->
      <section class="section">
        <h2 class="section__title">ë…¸ë˜ ì„ íƒ</h2>

        {% if songs and songs|length > 0 %}
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>ì„ íƒ</th>
                <th>ì»¤ë²„</th>
                <th>ì œëª©</th>
                <th>ì•„í‹°ìŠ¤íŠ¸</th>
                <th>ì•¨ë²”</th>
              </tr>
            </thead>
            <tbody>
              {% for s in songs %}
              <tr data-song-id="{{ s['song_id'] }}">
                <td>
                  <input type="checkbox" class="song-checkbox song-checkbox-bottom" name="song_ids"
                    value="{{ s['song_id'] }}" data-song-id="{{ s['song_id'] }}"
                    {% if selected_song_ids and s['song_id'] in selected_song_ids %}checked{% endif %}>
                </td>
                <td>
                  {% if s['cover_url'] %}
                  <img src="{{ s['cover_url'] }}" alt="cover" class="cover-thumb">
                  {% endif %}
                </td>
                <td>{{ s['title'] }}</td>
                <td>{{ s['artist'] or '-' }}</td>
                <td>{{ s['album'] or '-' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- â›”ï¸ í•˜ë‹¨ ì €ì¥ ë²„íŠ¼ ì œê±° (ìƒë‹¨ í—¤ë” ë²„íŠ¼ë§Œ ì‚¬ìš©) -->

        {% else %}
        <div class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        {% endif %}
      </section>
    </form>
  </div>

  <script>
    // ì œëª©/ì„¤ëª… ì—†ìœ¼ë©´ ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
    const titleInput = document.getElementById('playlist-title');
    const descInput = document.getElementById('playlist-description');
    const saveBtn = document.getElementById('save-button');

    function checkValid() {
      if (!saveBtn) return;
      const hasTitle = titleInput.value.trim().length > 0;
      const hasDesc = descInput.value.trim().length > 0;
      saveBtn.disabled = !(hasTitle && hasDesc);
    }

    if (titleInput && descInput && saveBtn) {
      titleInput.addEventListener('input', checkValid);
      descInput.addEventListener('input', checkValid);
      window.addEventListener('DOMContentLoaded', checkValid);
    }

    // ====== ì„ íƒëœ ë…¸ë˜ í…Œì´ë¸” ì‹¤ì‹œê°„ ë™ê¸°í™” ======
    function updateSelectedEmptyState() {
      const tbody = document.getElementById('selected-tbody');
      const wrapper = document.getElementById('selected-wrapper');
      const empty = document.getElementById('selected-empty');
      if (!tbody || !wrapper || !empty) return;

      const hasRows = tbody.querySelectorAll('tr').length > 0;
      if (hasRows) { wrapper.style.display = 'block'; empty.style.display = 'none'; }
      else { wrapper.style.display = 'none'; empty.style.display = 'block'; }
    }

    function removeFromSelected(id) {
      const row = document.querySelector('.selected-row[data-song-id="' + id + '"]');
      if (row) {
        const topCb = row.querySelector('.song-checkbox-top');
        if (topCb) topCb.checked = false;
        row.remove();
      }
      const bottomCb = document.querySelector('.song-checkbox-bottom[data-song-id="' + id + '"]');
      if (bottomCb) bottomCb.checked = false;
      updateSelectedEmptyState();
    }

    function addToSelectedFromBottom(id) {
      const existingRow = document.querySelector('.selected-row[data-song-id="' + id + '"]');
      if (existingRow) {
        const topCb = existingRow.querySelector('.song-checkbox-top');
        if (topCb) topCb.checked = true;
        updateSelectedEmptyState();
        return;
      }
      const bottomCb = document.querySelector('.song-checkbox-bottom[data-song-id="' + id + '"]');
      if (!bottomCb) { updateSelectedEmptyState(); return; }
      const bottomRow = bottomCb.closest('tr');
      if (!bottomRow) { updateSelectedEmptyState(); return; }

      const clone = bottomRow.cloneNode(true);
      clone.classList.add('selected-row');
      clone.setAttribute('data-song-id', id);

      const cb = clone.querySelector('input[type="checkbox"]');
      if (cb) {
        cb.classList.remove('song-checkbox-bottom');
        cb.classList.add('song-checkbox-top');
        cb.checked = true;
        cb.setAttribute('data-song-id', id);

        cb.addEventListener('change', () => {
          const bottom = document.querySelector('.song-checkbox-bottom[data-song-id="' + id + '"]');
          if (cb.checked) {
            if (bottom) bottom.checked = true;
            addToSelectedFromBottom(id);
          } else {
            if (bottom) bottom.checked = false;
            removeFromSelected(id);
          }
        });
      }

      const tbody = document.getElementById('selected-tbody');
      if (tbody) { tbody.appendChild(clone); }
      updateSelectedEmptyState();
    }

    // ====== ì»¤ë²„ URL ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ ======
    (function () {
      const input = document.getElementById('playlist-cover-url');
      const img = document.getElementById('coverPreviewImg');
      const placeholder = document.getElementById('coverPlaceholder');
      const overlay = document.getElementById('previewOverlay');
      const errorBox = document.getElementById('coverPreviewError');

      function showPlaceholder() {
        img.style.display = 'none';
        img.src = '';
        placeholder.style.display = 'block';
        errorBox.classList.remove('show');
      }
      function showError(text) {
        img.style.display = 'none';
        placeholder.style.display = 'block';
        errorBox.textContent = text || 'ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
        errorBox.classList.add('show');
        overlay.classList.remove('show');
      }
      function showImage(src) {
        overlay.classList.remove('show');
        errorBox.classList.remove('show');
        placeholder.style.display = 'none';
        img.src = src;
        img.style.display = 'block';
      }
      function updatePreview(url) {
        url = (url || '').trim();
        if (!url) { showPlaceholder(); return; }
        overlay.classList.add('show');
        errorBox.classList.remove('show');

        const pre = new Image();
        let timedOut = false;
        const to = setTimeout(() => { timedOut = true; pre.src = ''; showError('ì´ë¯¸ì§€ ë¡œë“œ ì‹œê°„ ì´ˆê³¼'); }, 8000);

        pre.onload = function () {
          if (timedOut) return;
          clearTimeout(to);
          showImage(url);
        };
        pre.onerror = function () {
          if (timedOut) return;
          clearTimeout(to);
          showError('ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (CORS ë˜ëŠ” ì˜ëª»ëœ URL)');
        };
        pre.src = url;
      }

      if (!input) return;
      let timer = null;
      input.addEventListener('input', () => {
        clearTimeout(timer);
        timer = setTimeout(() => updatePreview(input.value), 300);
      });
      input.addEventListener('blur', () => updatePreview(input.value));

      document.addEventListener('DOMContentLoaded', () => {
        const initial = input.value || "{{ cover_url_value or '' }}";
        updatePreview(initial);
      });
    })();

    // ====== ì´ˆê¸°í™” ======
    document.addEventListener('DOMContentLoaded', () => {
      updateSelectedEmptyState();

      document.querySelectorAll('.song-checkbox-bottom').forEach(cb => {
        cb.addEventListener('change', () => {
          const id = cb.getAttribute('data-song-id');
          if (cb.checked) addToSelectedFromBottom(id);
          else removeFromSelected(id);
        });
      });

      document.querySelectorAll('.song-checkbox-top').forEach(cb => {
        cb.addEventListener('change', () => {
          const id = cb.getAttribute('data-song-id');
          const bottom = document.querySelector('.song-checkbox-bottom[data-song-id="' + id + '"]');
          if (cb.checked) {
            if (bottom) bottom.checked = true;
            addToSelectedFromBottom(id);
          } else {
            if (bottom) bottom.checked = false;
            removeFromSelected(id);
          }
        });
      });
    });
  </script>
</body>
</html>
